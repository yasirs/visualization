<!DOCTYPE html>
<html>
  <head>
    <title>Force-Directed Layout with hierarchical structure</title>
    <script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="d3/d3.geom.js"></script>
    <script type="text/javascript" src="d3/d3.layout.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
  </head>
  <body>
    <div id="controlPanel">
      <p> W: <input type="text" name="w" id="w" value="960"/></p>
      <p> W: <input type="text" name="h" id="h" value="500"/></p>
      <p> <button type="button" name="WHButton" id="WHButton">Change!</button></p>
      <p> <button type="button" name="resumeButton" id="resumeButton">Resume Simulation</button></p>
      <p> <input type="checkbox" name="runSimul"/> - Forces</p>
    </div>
    <div id="chart"></div>
    <script type="text/javascript">

var w = 1000,
    h = 1000,
    fill = d3.scale.category10();

var readData = function(fEdges, fHier) {

	var readFile = function(fname) {
		var request = new XMLHttpRequest();  
		request.open('GET', fname, false);   
		request.send(null);  
  
		if (request.status == 0) {
  			return request.responseText;
		} else {
			alert("Couldn't read file "+fname);
			alert("status : "+request.status);
		}
	}

	var myIndex = function(myList,myName) {
		for (var i = myList.length-1; i>=0; i--) {
			if (myList[i]["name"]===myName) {
				return i;
			}
		}
		return -1;
	}

	function readEdges(fname) {
		var nodelist= [];
		var edgelist =[];
		textRead = readFile(fname);
		var lines = textRead.split("\n");
		for (var i = 0; i< lines.length; i++) {
			line = lines[i];
			var words= line.split('\t');
			if (words.length>1) {
				var src=words[0], trg=words[1];
				if (myIndex(nodelist,src)==-1) {
					nodelist.push({"name":src,"group":1});
				}
				if (myIndex(nodelist,trg)==-1) {
					nodelist.push({"name":trg,"group":1});
				}
				edgelist.push({"source":myIndex(nodelist,src),"target":myIndex(nodelist,trg),"type":"ordinary"});
			}
		}
		return [edgelist,nodelist];
	}
	
	
	function readHierarchical(fname, oldnodes) {
		var hedgelist = [];
		var newnodes = oldnodes.concat([]);
		textRead = readFile(fname);
		var lines = textRead.split("\n");
		for (var i = 0; i< lines.length; i++) {
			line = lines[i];
			var words= line.split('\t');
			if (words.length>1) {
				var src=words[1], trg=words[0];
				if (myIndex(newnodes,trg)==-1) {
					newnodes.push({"name":trg,"group":2});
				}
				if (myIndex(newnodes,src)==-1) {
					newnodes.push({"name":src,"group":2});
				}
				hedgelist.push({"source":myIndex(newnodes,src),"target":myIndex(newnodes,trg),"type":"hierarchical"});

			}
		}
		return [hedgelist,newnodes];
	}
	var eReturn  = readEdges(fEdges);
	var ordEdges = eReturn[0];
	var ordNames = eReturn[1];

	var hReturn  = readHierarchical(fHier,ordNames);
	var hierEdges = hReturn[0];
	var intNames = hReturn[1];
	return [intNames,ordEdges,hierEdges];
}

var dataRead = readData("a.edges","a.clusters");
var nodes = dataRead[0];;
var ordLinks = dataRead[1];
var hLinks = dataRead[2];

//var nodes = [{"name":"a","group":0},{"name":"b","group":0},{"name":"c","group":1},{"name":"d","group":1},{"name":"e","group":2},{"name":"0","group":3},{"name":"1","group":3},{"name":2,"group":3},{"name":"3","group":3}];
//var ordLinks = [{"source":0,"target":1},{"source":2,"target":4},{"source":3,"target":4}];
//var hLinks = [{"source":0,"target":5},{"source":1,"target":5},{"source":2,"target":6},{"source":3,"target":6},{"source":4,"target":7},{"source":6,"target":7},{"source":5,"target":8},{"source":7,"target":8}]
//var ordLinks=[];
var vis = d3.select("#chart").append("svg:svg")
    .attr("width", w)
    .attr("height", h);

var force = d3.layout.force()
    .charge(-300)
    .linkDistance(30)
    .linkStrength(function(l) {if (l.type==="ordinary") return 1; else return 3;})
    .nodes(nodes)
    .links(ordLinks.concat(hLinks))
    .size([w, h])
    .start();

var link = vis.selectAll("line.link")
      .data(ordLinks.concat(hLinks))
    .enter().append("svg:line")
      .attr("stroke", "#999")
      .style("stroke-width", 3)
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });


var node = vis.selectAll("circle.node")
    .data(nodes)
  .enter().append("svg:circle")
    .attr("cx", function(d) { return d.x; })
    .attr("cy", function(d) { return d.y; })
    .attr("r", 8)
    .style("fill", function(d, i) { return fill(d.group); })
    .call(force.drag);

node.append("svg:title")
      .text(function(d) { return d.name; });


link.append("svg:title")
      .text(function(d) { if (d.type==="hierarchical") return (d.source.name + " => " + d.target.name); 
				else return (d.source.name + " - " + d.target.name );
			}); 


vis.style("opacity", 1e-6)
  .transition()
    .duration(1000)
    .style("opacity", 1);

force.on("tick", function(e) {

  // Push different nodes in different directions for clustering.
  var k = 40 * e.alpha;
  hLinks.forEach(function(hlink) {
	var yB = hlink.source.y, yT = hlink.target.y;
	if (yB<(yT+20)) { hlink.source.y += Math.min(k,yT+20-yB); hlink.target.y -= Math.min(k,yT+20-yB);}
	var xB = hlink.source.x, xT = hlink.target.x;
	if (xB<(xT-20)) { hlink.source.x += Math.min(k,xT-20-xB); hlink.target.x -= Math.min(k,xT-20-xB);}
	if (xB>(xT+20)) { hlink.source.x -= Math.min(k,xB-xT-20); hlink.target.x += Math.min(k,xB-xT-20);}
	
  });

  node.attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; });

  link.attr("x1", function(d) { return d.source.x; })
       .attr("y1", function(d) { return d.source.y; })
       .attr("x2", function(d) { return d.target.x; })
       .attr("y2", function(d) { return d.target.y; });



});



$("html body div#controlPanel p button#resumeButton").click(function() {
force.resume();
});




$("html body div#controlPanel p button#WHButton").click(function() {
  alert("clicked!, w = "+$('html body div#controlPanel p input#w').val());
  vis.attr("width", parseInt($('html body div#controlPanel p input#w').val()));
  vis.attr("height", parseInt($('html body div#controlPanel p input#h').val()));
});


//$("html body div#controlPanel p button").click(funtion() {
  //vis.width = $('html body div#controlPanel p input#w').value();
  //vis.height = $('html body div#controlPanel p input#h').value();
//  alert("clicked!")
//});


    </script>
  </body>
</html>
